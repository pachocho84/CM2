{% extends 'CMBundle:User:accountLayout.html.twig' %}

{% block section %}{{ 'Work'|trans }}{% endblock %}

{% form_theme form _self %}

{% block _cm_cmbundle_work_collection_works_entry_widget %}
    <div class="well well-sm work-form">
        <p class="clearfix{% if form.vars.data is null or form.vars.data.position is null and form.position.vars.errors|length == 0 %} hidden{% endif %}"><button type="button" class="close" aria-hidden="true" remove-link>&times;</button></p>
        <div class="row">
            <div class="col-sm-6">
                {{ form_row(form.position, {attr: {required: true}}) }}
            </div>
            <div class="col-sm-6">
                {{ form_row(form.company) }}
            </div>
        </div>
        <div class="row">
            <div class="col-sm-5">
                {{ form_row(form.dateFrom) }}
            </div>
            <div class="col-sm-5 current-input-target">
                {{ form_row(form.dateTo) }}
            </div>
            <div class="col-sm-2">
                <div class="checkbox">
                    <label><input type="checkbox" class="current-input" value="0">{{ 'Current'|trans }}</label>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                {{ form_row(form.description) }}
            </div>
        </div>
    </div>
{% endblock %}

{% block main %}
    <div class="box">
        <div class="box-heading">
            <h2>{{ icon('Work') }} {{ 'Work' }}</h2>
        </div>

        <div class="box-body">
            {{ form(form) }}
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
        $(function(){
            /* EDUCATION */
            $(document).on('keydown', 'form .work-form:last', function(event) {
                var $form = $(event.currentTarget);
                var $collection = $form.closest('[data-prototype]');
                var index = $collection.find('.work-form :input').length;
                var $newForm = $($collection.data('prototype').replace(/__name__label__/g, index).replace(/__name__/g, index));

                $form.find('[remove-link]').parent().removeClass('hidden');
                $form.after($newForm);

                $(event.currentTarget).trigger('collection-added', $newForm);
            });
            $(document).on('click', '[remove-link]', function(event) {
                event.preventDefault();

                $(event.currentTarget).closest('.work-form').remove();
            });
            $(document).on('submit', 'form', function(event) {
                $(event.currentTarget).find('.work-form:last [name]').attr('name', '');
            });
            $(document).on('change', '.current-input', function(event) {
                console.log(42);
                var datetimepicker = $(event.currentTarget).closest('.work-form').find('.current-input-target [datepicker-container]').data('datetimepicker');
                var $button = $(event.currentTarget).closest('.work-form').find('.current-input-target [datepicker-container] .btn');
                if ($(event.currentTarget).is(':checked')) {
                    $button.attr('disabled', 'disabled');
                    var date = new Date();
                    date = new Date(Date.UTC.apply(Date, [date.getFullYear(), date.getMonth(), date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds(), 0]));
                    datetimepicker.viewMode = datetimepicker.startViewMode;
                    datetimepicker.showMode(0);
                    datetimepicker._setDate(date);
                    datetimepicker.fill();
                } else {
                    datetimepicker.reset();
                    $button.removettr('disabled');
                }
            });
        });
    </script>
{% endblock %}