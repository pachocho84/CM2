{% extends 'CMBundle:User:accountLayout.html.twig' %}

{% block section %}{{ 'Work'|trans }}{% endblock %}

{% form_theme form _self %}

{% block _cm_cmbundle_work_collection_works_widget %}
    {% if prototype is defined %}
        {% set attr = attr|merge({'data-prototype': form_row(prototype) }) %}
    {% endif %}
    <div class="box" {{ block('widget_container_attributes') }}>
        <div class="box-heading">
            <h2>{{ icon('Work') }} {{ block('section') }}</h2>
        </div>

        <div class="box-body">
            {{ block('form_rows') }}
        </div>
    </div>
{% endblock %}

{% block _cm_cmbundle_work_collection_works_entry_widget %}
    <div class="panel panel-default work-form">
        <div class="panel-heading">
            {{ 'work'|trans }}
            {% if form.vars.data is not null and form.vars.data.position is not null or form.position.vars.errors|length != 0 %}
                <a class="btn btn-default pull-right" remove-link href="#">{{ icon('Remove') }}</a>
            {% endif %}
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-sm-4">
                    {{ form_row(form.position, {attr: {required: true}}) }}
                </div>
                <div class="col-sm-4">
                    {{ form_row(form.employer) }}
                </div>
                <div class="col-sm-4">
                    {{ form_row(form.company) }}
                </div>
            </div>
            <div class="row">
                <div class="col-sm-5">
                    {{ form_row(form.dateFrom) }}
                </div>
                <div class="col-sm-5 current-input-target">
                    {{ form_row(form.dateTo) }}
                </div>
                <div class="col-sm-2">
                    <div class="form-group">
                        <label class="checkbox-inline"><input type="checkbox" class="current-input" value="0">{{ 'Current'|trans }}</label>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    {{ form_row(form.description) }}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block main %}
    {{ form(form) }}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
        $(function(){
            /* EDUCATION */
            $(document).on('keydown', 'form .work-form:last', function(event) {
                var $form = $(event.currentTarget);
                var $collection = $form.closest('[data-prototype]');
                var index = $collection.find('.work-form :input').length;
                var newForm = $collection.data('prototype').replace(/__name__label__/g, index).replace(/__name__/g, index);

                $form.find('.panel-heading').append('<a class="btn btn-default pull-right" remove-link href="#">{{ icon('Remove') }}</a>');
                $form.after($(newForm));
            });
            $(document).on('click', '[remove-link]', function(event) {
                event.preventDefault();

                $(event.currentTarget).closest('.work-form').remove();
            });
            $(document).on('submit', 'form', function(event) {
                $(event.currentTarget).find('.work-form:last [name]').attr('name', '');
            });
            $(document).on('change', '.current-input', function(event) {
                var datetimepicker = $(event.currentTarget).closest('.work-form').find('.current-input-target [datepicker-container]').data('datetimepicker');
                var $button = $(event.currentTarget).closest('.work-form').find('.current-input-target [datepicker-container] .btn');
                if ($(event.currentTarget).is(':checked')) {
                    $button.attr('disabled', 'disabled');
                    var date = new Date();
                    date = new Date(Date.UTC.apply(Date, [date.getFullYear(), date.getMonth(), date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds(), 0]));
                    datetimepicker.viewMode = datetimepicker.startViewMode;
                    datetimepicker.showMode(0);
                    datetimepicker._setDate(date);
                    datetimepicker.fill();
                } else {
                    datetimepicker.reset();
                    $button.removettr('disabled');
                }
            });
        });
    </script>
{% endblock %}