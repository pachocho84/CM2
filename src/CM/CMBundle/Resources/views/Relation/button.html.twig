<div class="btn-group ajax-link-target relations-menu">

    {% if relations|length == 1 and (relations|first).accepted == constant('CM\\CMBundle\\Entity\\Relation::ACCEPTED_BOTH') %}
        {% set btnColour = 'success' %}
        {% set reqText = (relations|first).relationType.name %}
    {% elseif relations|length == 1 and (relations|first).accepted == constant('CM\\CMBundle\\Entity\\Relation::ACCEPTED_NO') %}
        {% set btnColour = 'warning' %}
        {% set reqText = (relations|first).relationType.name %}
    {% elseif relations|length == 1 and (relations|first).accepted == constant('CM\\CMBundle\\Entity\\Relation::ACCEPTED_UNI') %}
        {% set btnColour = 'danger' %}
        {% set reqText = (relations|first).relationType.name %}
    {% elseif relations|length > 1 %}
        {% set btnColour = 'success' %}
        {% set reqText = relations|length ~ ' connections' %}
        {% for relation in relations if relation.fromUserId == app.user.id and relation.accepted != constant('CM\\CMBundle\\Entity\\Relation::ACCEPTED_BOTH') %}
            {% set btnColour = 'warning' %}
            {% set reqText = relations|length ~ ' connections' %}
        {% endfor %}
    {% else %}
        {% set btnColour = 'default' %}
        {% set reqText = 'Request a relation' %}
    {% endif %}
    <button type="button" class="btn btn-{{ btnColour }} dropdown-toggle" data-toggle="dropdown">{{ icon('Relation') }} {{ reqText|trans }}</button>
    <ul class="dropdown-menu">
        
        <div class="relation-menu-body">
	        <li class="dropdown-header">{{ 'Public networks'|trans }}</li>
	
	        {% for relationType in relationTypes if relationType.userId is null %}
                {% if relations is not null and relationType.id in relations|keys %}
                    {% set relation = relations[relationType.id] %} {# WARNING: it's the inverse relation! #}
                    {% if relation.id in requests|keys %}
                        {% set request = requests[relation.id] %}
                    {% else %}
                        {% set request = null %}
                    {% endif %}
                {% else %}
                    {% set relation = null %}
                    {% set request = null %}
                {% endif %}

                <li>
                    {% if relation is null or request is null %}
                        <a href="{{ path('request_add', {object: 'Relation', objectId: app.user.id, userId: user.id, type: relationType.id}) }}" class="ajax-link">
                            <span class="checkbox" checked="false"><span class="glyphicon"></span></span>
                            {{ relationType|trans }}
                        </a>
                    {% elseif relation.accepted == constant('CM\\CMBundle\\Entity\\Relation::ACCEPTED_NO') %}
                        <a href="{{ path('request_delete', {'id': request.id}) }}" class="ajax-link">
                            <span class="checkbox" checked="true"><span class="glyphicon"></span></span>
                            {{ relationType|trans }} ({{ 'pending'|trans }})
                        </a>
                    {% elseif relation.accepted == constant('CM\\CMBundle\\Entity\\Relation::ACCEPTED_UNI') %}
                        {{ relationType|trans }} ({{ 'pending'|trans }})
                        <a href="{{ path('request_update', {'choice': 'accept', 'id': request.id}) }}" class="ajax-link">{{ 'Accept'|trans }}</a>
                        <a href="{{ path('request_delete', {'id': request.id}) }}" class="ajax-link">{{ 'Refuse'|trans }}</a>
                    {% elseif relation.accepted == constant('CM\\CMBundle\\Entity\\Relation::ACCEPTED_BOTH') %}
                        <a href="{{ path('request_delete', {'id': request.id}) }}" class="ajax-link">
                            <span class="checkbox" checked="true"><span class="glyphicon"></span></span>
                            {{ relationType|trans }}
                        </a>
                    {% endif %}
                </li>
	        {% endfor %}
		</div>
		
        <li class="divider"></li>

        <div class="dropdown-footer">
            <li class="dropdown-header">{{ 'Add a new private relation'|trans }}</li>
            <li>
                {{ form_start(form) }}
                    {{ form_widget(form.name, {no_container_class: true, attr: {class: 'input-lg'}}) }}
                {{ form_end(form) }}
            </li>
        </div>

    </ul>

</div>

{#
<div class="btn-group ajax-link-target">
    
    {% if relations is null %}
       
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">{{ icon('Relation') }} {{ 'Request a relation'|trans }}</button>
        <ul class="dropdown-menu">
            <li class="dropdown-header">{{ 'Request a relation'|trans }}</li>
            <li class="divider"></li>

            {% for relationType in relationTypes if relationType.userId is null %}
                <li><a href="{{ path('request_add', {'object': 'Relation', 'objectId': app.user.id, 'userId': user.id, 'type': relationType.inverseTypeId}) }}" class="ajax-link">{{ relationType|trans }}</a></li>
            {% endfor %}

            <li class="divider"></li>

            {% for relationType in relationTypes if relationType.userId is not null %}
                <li><a href="{{ path('request_add', {'object': 'Relation', 'objectId': app.user.id, 'userId': user.id, 'type': relationType.inverseTypeId}) }}" class="ajax-link">{{ relationType|trans }}</a></li>
            {% endfor %}
        </ul>

    {% elseif relation.accepted and inverse.accepted %}

        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">{{ icon('Relation') }} {{ 'inverse'|trans }}</button>
        <ul class="dropdown-menu">
            <li class="dropdown-header">{{ ('%user% is your ' ~ inverse)|trans({'%user%': user.firstName}) }}</li>
            <li class="divider"></li>
            <li><a href="{{ path('request_delete', {'id': request.id}) }}" class="ajax-link">{{ 'Cancel relation'|trans }}</a></li>
        </ul>

    {% elseif relation.accepted and not inverse.accepted %}

        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">{{ icon('Relation') }} {{ 'inverse'|trans }}</button>
        <ul class="dropdown-menu">
            <li class="dropdown-header">{{ ('You said %user% is your ' ~ inverse)|trans({'%user%': user.firstName}) }}</li>
            <li class="divider"></li>
            <li><a href="{{ path('request_delete', {'id': request.id}) }}" class="ajax-link">{{ 'Cancel relation'|trans }}</a></li>
        </ul>

    {% elseif not relation.accepted and inverse.accepted %}

        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">{{ icon('Relation') }} {{ 'relation'|trans }}</button>
        <ul class="dropdown-menu">
            <li class="dropdown-header">{{ ('%user% said you are *FIXME* ' ~ relation)|trans({'%user%': user.firstName}) }}</li>
            <li class="divider"></li>
            <li><a href="{{ path('request_update', {'choice': 'accept', 'id': request.id}) }}" class="ajax-link">{{ 'Accept'|trans }}</a></li>
            <li><a href="{{ path('request_delete', {'id': request.id}) }}" class="ajax-link">{{ 'Refuse'|trans }}</a></li>
        </ul>

    {% endif %}
</div>
#}