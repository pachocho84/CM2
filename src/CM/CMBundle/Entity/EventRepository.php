<?php

namespace CM\CMBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Tools\Pagination\Paginator;

/**
 * EventRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class EventRepository extends EntityRepository
{
    
	static protected function getOptions(array $options = array())
	{
		return array_merge(array(
			'user_id'     => null,
			'category'    => null, 
			'paginate'	  => true,
			'locale'	  => 'en',
			'locales'     => array_values(array_merge(array('en' => 'en'), array($options['locale'] => $options['locale']))),
			'limit'       => 25,
		), $options);
	}
    
    public function getEvents(array $options = array())
    {
        $options = self::getOptions($options);

        $parameters = array(
			'now' => new \DateTime,
            'locales' => $options['locales']
        );
        
        $eventDateRepository = $this->getEntityManager()->getRepository('CMBundle:EventDate');
        
        $query = $eventDateRepository->createQueryBuilder('d')->select('d, e, t, i, p, l, c, u')
            ->join('d.event', 'e')
            ->leftJoin('e.translations', 't')
            ->leftJoin('e.images', 'i', 'WITH', 'i.main = '.true)
            ->leftJoin('e.posts', 'p', 'WITH', 'p.type = '.Post::TYPE_CREATION)
            ->leftJoin('p.likes', 'l')
            ->leftJoin('p.comments', 'c')
            ->leftJoin('l.user', 'u');
        
        if (isset($options['category'])) {
            $query->andWhere('e.entityCategory = :category');
            $parameters['category'] = $options['category'];
        }
        
        if (isset($options['archive'])) {
            $query->andWhere('d.start <= :now')->orderBy('d.start', 'desc');    
        }
        else {
            $query->andWhere('d.start >= :now')->orderBy('d.start');    
        }
            
        $query
            ->andWhere('t.locale in (:locales)')
            ->setParameters($parameters);
            
        
        return $options['paginate'] ? $query : $query->setMaxResults($options['limit'])->getQuery()->getResult();
    }
	
	public function getEventsPerMonth($year, $month, array $options = array())
	{
		$options = self::getOptions($options);
		
		$eventDateRepository = $this->getEntityManager()->getRepository('CMBundle:EventDate');
		
		return $eventDateRepository->createQueryBuilder('d')->select('d, e, t')
			->join('d.event', 'e')
			->leftJoin('e.translations', 't')
			->where('SUBSTRING(d.start, 1, 4) = '.$year)
			->andWhere('SUBSTRING(d.start, 6, 2) = '.$month)
			->andWhere('t.locale IN (:locales)')->setParameter('locales', $options['locales'])
			->orderBy('d.start')
			->getQuery()
			->getResult();
	}

    public function getEvent($id, array $options = array())
    {
		$options = self::getOptions($options);
		
        return $this->createQueryBuilder('e')->select('e, t, d, i')
            ->leftJoin('e.eventDates', 'd')
            ->leftJoin('e.translations', 't')
            ->leftJoin('e.images', 'i')
            ->andWhere('e.id = :id')->setParameter('id', $id)
            ->andWhere('t.locale IN (:locales)')->setParameter('locales', $options['locales'])
            ->getQuery()
            ->getSingleResult();
    }

    public function getDate($id, array $options = array())
	{	
		$options = self::getOptions($options);
		
        $eventDateRepository = $this->getEntityManager()->getRepository('CMBundle:EventDate');
		
		return $eventDateRepository->createQueryBuilder('d')->select('d, e, t, i')
			->join('d.event', 'e')
            ->leftJoin('e.translations', 't')
            ->leftJoin('e.images', 'i')
            ->andWhere('d.id = :id')->setParameter('id', $id)
            ->andWhere('t.locale IN (:locales)')->setParameter('locales', $options['locales'])
            ->getQuery()
            ->getSingleResult();
    }

    public function getSponsored(array $options = array())
	{	
		$options = self::getOptions($options);
		
        $sponsoredRepository = $this->getEntityManager()->getRepository('CMBundle:Sponsored');
		
		return $sponsoredRepository->createQueryBuilder('s')->select('s, e, d, t, i')
			->join('s.event', 'e')
			->leftJoin('e.eventDates', 'd')
            ->leftJoin('e.translations', 't')
            ->leftJoin('e.images', 'i', 'WITH', 'i.main = '.true)
            ->andWhere('s.start <= :now')
            ->andWhere('s.end >= :now')
            ->andWhere('t.locale IN (:locales)')
            ->setParameters(array(
                ':now' => new \DateTime,
                ':locales' => $options['locales']
            ))
            ->setMaxResults($options['limit'])
            ->orderBy('s.views')
            ->getQuery()
            ->getResult();
    }
}